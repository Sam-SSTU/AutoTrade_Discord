<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Channel Manager</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.ico') }}">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        #app {
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 100% !important;
            padding: 0 !important;
        }
        .main-content {
            height: calc(100vh - 100px);
            display: flex;
            gap: 20px;
        }
        .channels-container {
            width: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .messages-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .card {
            background-color: #fff;
            border: 1px solid #dee2e6;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 16px;
        }
        .card-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .channel-list {
            height: 100%;
            overflow-y: auto;
        }
        .message-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: #f5f5f5;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .author {
            font-weight: bold;
            color: #333;
        }
        .time {
            color: #666;
            font-size: 0.9em;
        }
        .message-content {
            word-break: break-word;
        }
        .text-content {
            margin-bottom: 0.5rem;
        }
        .attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .attachment-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .attachment-image:hover {
            transform: scale(1.05);
        }
        .image-preview-dialog {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
        }
        .category-header {
            padding: 8px 16px;
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 500;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #dee2e6;
        }
        .category-header:hover {
            background-color: #e9ecef;
        }
        .channel-item {
            padding: 4px 8px;
            cursor: pointer;
            color: #8e9297;
        }
        .channel-item:hover {
            background-color: rgba(79,84,92,0.16);
            color: #dcddde;
        }
        .channel-item.active {
            background-color: rgba(79,84,92,0.32);
            color: #fff;
        }
        .channel-item .btn,
        .thread-item .btn {
            padding: 2px 8px;
            font-size: 12px;
        }
        .channel-item .btn:hover,
        .thread-item .btn:hover {
            background-color: rgba(79,84,92,0.32);
            border-color: transparent;
            color: #fff;
        }
        .message-item {
            margin-bottom: 16px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .message-item:hover {
            background-color: #f8f9fa;
        }
        .clock-display {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9em;
            padding: 8px 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            display: inline-flex;
            align-items: center;
            gap: 20px;
        }
        .clock-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .clock-label {
            font-size: 0.8em;
            color: #6c757d;
            font-weight: 500;
        }
        .clock-time {
            font-size: 1em;
            color: #212529;
            letter-spacing: 0.5px;
            min-width: 200px;
        }
        .clock-separator {
            color: #dee2e6;
            margin: 0 10px;
        }
        .unread-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.8em;
            min-width: 20px;
            text-align: center;
        }
        .channel-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .channel-icon {
            font-size: 1.2em;
            color: #6c757d;
        }
        .connection-status {
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header-left h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .connection-status.connected {
            background-color: #67C23A;
            color: white;
        }
        .connection-status.disconnected {
            background-color: #F56C6C;
            color: white;
        }
        .connection-status i {
            font-size: 16px;
        }
        .header-right {
            display: flex;
            align-items: center;
        }
        .time-display {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 15px;
            background-color: #f5f7fa;
            border-radius: 4px;
            border: 1px solid #e4e7ed;
        }
        .time-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .time-label {
            font-size: 12px;
            color: #909399;
            font-weight: 500;
        }
        .time-value {
            font-size: 14px;
            color: #303133;
            font-family: 'Roboto Mono', monospace;
        }
        .time-separator {
            color: #dcdfe6;
        }
        .card-header .btn {
            padding: 4px 8px;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 4px;
        }
        .btn-outline-secondary {
            color: #606266;
            border-color: #dcdfe6;
        }
        .btn-outline-secondary:hover {
            color: #409EFF;
            border-color: #c6e2ff;
            background-color: #ecf5ff;
        }
        .btn-outline-primary {
            color: #409EFF;
            border-color: #b3d8ff;
        }
        .btn-outline-primary:hover {
            color: #fff;
            background-color: #409EFF;
            border-color: #409EFF;
        }
        .referenced-content {
            margin: 8px 0;
        }
        .quote-box {
            background-color: #f5f7fa;
            border-left: 4px solid #409EFF;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 0 4px 4px 0;
        }
        .quote-header {
            color: #409EFF;
            font-size: 0.9em;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .quote-text {
            color: #606266;
            font-size: 0.95em;
            white-space: pre-wrap;
        }
        .forum-channel {
            margin-left: 8px;
        }
        .forum-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            cursor: pointer;
            color: #8e9297;
        }
        .forum-header:hover {
            background-color: rgba(79,84,92,0.16);
            color: #dcddde;
        }
        .forum-header .btn {
            padding: 2px 8px;
            font-size: 12px;
        }
        .forum-header .btn:hover {
            background-color: rgba(79,84,92,0.32);
            border-color: transparent;
            color: #fff;
        }
        .forum-threads {
            margin-left: 16px;
        }
        .thread-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            color: #8e9297;
        }
        .thread-item:hover {
            background-color: rgba(79,84,92,0.16);
            color: #dcddde;
        }
        .thread-item.active {
            background-color: rgba(79,84,92,0.32);
            color: #fff;
        }
    </style>
</head>
<body>
    {% raw %}
    <div id="app">
        <div class="header">
            <div class="header-left">
                <h1>Discord Channel Manager</h1>
                <div class="connection-status" :class="{ 'connected': isConnected, 'disconnected': !isConnected }">
                    <i class="el-icon-connection"></i>
                    <span v-text="isConnected ? '已连接' : '未连接'"></span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-outline-primary me-3" @click="toggleDevMode">
                    <i class="el-icon-setting"></i>
                    <span v-text="devMode ? '退出开发者模式' : '开发者模式'"></span>
                </button>
                <a href="/ai" class="btn btn-primary me-3">
                    <i class="el-icon-message"></i>
                    AI消息
                </a>
                <div class="time-display">
                    <div class="time-item">
                        <span>UTC</span>
                        <span v-text="utcTime"></span>
                    </div>
                    <div class="time-separator">|</div>
                    <div class="time-item">
                        <span v-text="selectedTimezone"></span>
                        <span v-text="localTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="channels-container">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Channels</h5>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" 
                                       v-model="channelSearch" 
                                       placeholder="Search...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div v-for="category in groupedChannels" :key="category.id" class="category">
                            <div class="category-header" @click="toggleCategory(category.id)">
                                <span v-text="category.name || '未分类'"></span>
                            </div>
                            <div v-show="expandedCategories[category.id]" class="category-content">
                                <div v-for="channel in category.channels" :key="channel.id" class="channel-item">
                                    <div v-if="channel.threads" class="forum-channel">
                                        <div class="forum-header">
                                            <div class="d-flex align-items-center gap-2" @click="toggleForum(channel.id)">
                                                <i class="el-icon-chat-dot-square"></i>
                                                <span class="channel-text" v-text="channel.name"></span>
                                                <span v-if="unreadCounts[channel.id]" 
                                                      class="unread-badge"
                                                      v-text="unreadCounts[channel.id]">
                                                </span>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <button class="btn btn-sm" 
                                                        :class="channel.is_forwarding ? 'btn-success' : 'btn-outline-secondary'"
                                                        @click.stop="toggleForwarding(channel)"
                                                        v-if="devMode">
                                                    <i class="el-icon-connection"></i>
                                                    {{ channel.is_forwarding ? '已开启' : '已关闭' }}
                                                </button>
                                            </div>
                                        </div>
                                        <div v-show="expandedForums[channel.id]" class="forum-threads">
                                            <div v-for="thread in channel.threads" :key="thread.id" 
                                                 class="thread-item"
                                                 :class="{ active: selectedChannel && selectedChannel.platform_channel_id === thread.platform_channel_id }"
                                                 @click="selectChannel(thread)">
                                                <div class="d-flex align-items-center justify-content-between w-100">
                                                    <div class="d-flex align-items-center">
                                                        <i class="el-icon-chat-line-square"></i>
                                                        <span class="channel-text" v-text="thread.name"></span>
                                                        <span v-if="unreadCounts[thread.platform_channel_id]" 
                                                              class="unread-badge"
                                                              v-text="unreadCounts[thread.platform_channel_id]">
                                                        </span>
                                                    </div>
                                                    <button class="btn btn-sm" 
                                                            :class="thread.is_forwarding ? 'btn-success' : 'btn-outline-secondary'"
                                                            @click.stop="toggleForwarding(thread)"
                                                            v-if="devMode">
                                                        <i class="el-icon-connection"></i>
                                                        {{ thread.is_forwarding ? '已开启' : '已关闭' }}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else
                                         class="channel-item"
                                         :class="{ active: selectedChannel && selectedChannel.platform_channel_id === channel.platform_channel_id }"
                                         @click="selectChannel(channel)">
                                        <div class="d-flex align-items-center justify-content-between w-100">
                                            <div class="d-flex align-items-center">
                                                <i class="el-icon-chat-line-square"></i>
                                                <span class="channel-text" v-text="channel.name"></span>
                                                <span v-if="unreadCounts[channel.platform_channel_id]" 
                                                      class="unread-badge"
                                                      v-text="unreadCounts[channel.platform_channel_id]">
                                                </span>
                                            </div>
                                            <button class="btn btn-sm" 
                                                    :class="channel.is_forwarding ? 'btn-success' : 'btn-outline-secondary'"
                                                    @click.stop="toggleForwarding(channel)"
                                                    v-if="devMode">
                                                <i class="el-icon-connection"></i>
                                                {{ channel.is_forwarding ? '已开启' : '已关闭' }}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="messages-container">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" v-text="selectedChannel ? selectedChannel.name : 'Select a channel'"></h5>
                            <div v-if="selectedChannel" class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" @click="refreshMessages">
                                    <i class="el-icon-refresh"></i>
                                    刷新
                                </button>
                                <button v-if="hasUnreadMessages" 
                                        class="btn btn-outline-secondary btn-sm"
                                        @click="markAllChannelsRead">
                                    <i class="el-icon-check"></i>
                                    清除未读
                                </button>
                                <button class="btn btn-outline-primary btn-sm" @click="toggleAddMessageForm">
                                    <i class="el-icon-plus"></i>
                                    {{ showAddMessageForm ? '取消' : '发送消息' }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body message-list" ref="messageList" @scroll="handleScroll">
                        <div v-if="selectedChannel">
                            <div v-if="showAddMessageForm" class="mb-3 p-3 border rounded bg-light">
                                <div class="mb-2">
                                    <label class="form-label">Message Content:</label>
                                    <textarea class="form-control" v-model="newMessage.content" rows="3"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Author Name:</label>
                                    <input type="text" class="form-control" v-model="newMessage.author_name">
                                </div>
                                <div>
                                    <button class="btn btn-primary me-2" @click="addMessage" :disabled="!newMessage.content">
                                        Send
                                    </button>
                                </div>
                            </div>
                            <div v-for="message in messages" :key="message.id" class="message">
                                <div class="message-header">
                                    <span class="author">{{ message.author_name }}</span>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="time">{{ formatDate(message.created_at) }}</span>
                                        <button v-if="devMode" 
                                                class="btn btn-outline-danger btn-sm" 
                                                style="padding: 2px 4px; font-size: 12px;"
                                                @click="deleteMessage(message.id)">
                                            <i class="el-icon-delete"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <div class="text-content">{{ message.content }}</div>
                                    <div v-if="message.referenced_content" class="referenced-content">
                                        <div class="quote-box">
                                            <div class="quote-header">引用消息:</div>
                                            <div class="quote-text">{{ message.referenced_content }}</div>
                                        </div>
                                    </div>
                                    <div v-if="message.attachments && message.attachments.length > 0" class="attachments">
                                        <div v-for="attachment in message.attachments" :key="attachment.id" class="attachment">
                                            <img v-if="attachment.content_type && attachment.content_type.startsWith('image/')"
                                                 :src="`/api/messages/attachments/${attachment.id}`"
                                                 :alt="attachment.filename"
                                                 class="attachment-image"
                                                 @click="showImagePreview(attachment)"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="loading" class="text-center mt-3">Loading...</div>
                        </div>
                        <div v-else class="text-center mt-3">
                            Please select a channel to view messages
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 开发者模式面板 -->
        <div v-if="devMode" class="row mt-4">
            <!-- 开发者工具 -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        Developer Tools
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Time Zone Settings</label>
                            <select class="form-select mb-2" 
                                    :value="selectedTimezone"
                                    @change="updateTimezone($event.target.value)">
                                <option value="UTC">UTC</option>
                                <option value="local">Local Time</option>
                                <option value="Asia/Shanghai">Asia/Shanghai</option>
                                <option value="America/New_York">America/New_York</option>
                                <option value="Europe/London">Europe/London</option>
                                <option value="Asia/Tokyo">Asia/Tokyo</option>
                            </select>
                            <small class="text-muted">Select timezone for message timestamps and system clock</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Channel Management</label>
                            <button class="btn btn-primary w-100 mb-2" @click="syncChannels" :disabled="isSyncing">
                                {{ isSyncing ? '同步中...' : '同步频道和帖子' }}
                            </button>
                            <small class="text-muted">同步可访问的频道和论坛帖子，自动跳过无权限频道</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Sync History Messages</label>
                            <div class="input-group mb-2">
                                <input type="number" class="form-control" v-model="historyMessageCount" placeholder="Number of messages">
                                <button class="btn btn-primary" @click="syncHistoryMessages" :disabled="isSyncing">
                                    {{ isSyncing ? 'Syncing...' : '同步历史消息' }}
                                </button>
                            </div>
                            <div class="input-group">
                                <input type="number" class="form-control" v-model="historyMessageCount" placeholder="Number of messages">
                                <button class="btn btn-outline-primary" @click="syncThreads" :disabled="isSyncing">
                                    {{ isSyncing ? 'Syncing...' : '同步帖子消息' }}
                                </button>
                            </div>
                            <small class="text-muted">输入要从每个频道和论坛帖子同步的消息数量</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Database Operations</label>
                            <button class="btn btn-danger w-100" @click="clearDatabase">
                                Clear All Messages
                            </button>
                            <small class="text-muted">This will delete all messages from the database</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <el-dialog :visible.sync="imagePreviewVisible" :append-to-body="true" class="image-preview-dialog">
            <img :src="previewImageUrl" class="preview-image" alt="Preview" />
        </el-dialog>
    </div>
    {% endraw %}

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        Vue.use(ELEMENT);
        
        new Vue({
            el: '#app',
            data: {
                channels: [],
                channelSearch: '',
                selectedChannel: null,
                messages: [],
                showAddMessageForm: false,
                newMessage: {
                    content: '',
                    author_name: ''
                },
                unreadCounts: {},
                lastMessageTimes: {},
                messageCheckInterval: null,
                searchQuery: '',
                ws: null,
                currentPage: 1,
                pageSize: 20,
                loading: false,
                hasMore: true,
                // 开发者工具相关
                historyMessageCount: 100,
                isSyncing: false,
                devMode: true,
                selectedTimezone: localStorage.getItem('selectedTimezone') || 'UTC',
                utcTime: '',
                localTime: '',
                clockInterval: null,
                expandedCategories: {},
                expandedForums: {},
                isConnected: false,
                connectionStatus: '检查中',
                reconnectAttempts: 0,
                imagePreviewVisible: false,
                previewImageUrl: '',
            },
            computed: {
                filteredChannels() {
                    if (!this.channelSearch) {
                        return this.channels;
                    }
                    const query = this.channelSearch.toLowerCase();
                    return this.channels.filter(channel => 
                        channel.name.toLowerCase().includes(query)
                    );
                },
                hasUnreadMessages() {
                    return Object.values(this.unreadCounts).some(count => count > 0);
                },
                groupedChannels() {
                    if (!this.channels.length) return [];
                    
                    // 首先按照 parent_id 分组
                    const groups = {};
                    const uncategorized = [];
                    
                    // 找出所有分类（包括Discord原生分类和分隔符分类）
                    this.channels.forEach(channel => {
                        if (channel.type === 4 && channel.is_active !== false) { // 分类类型且未被禁用
                            groups[channel.platform_channel_id] = {
                                id: channel.platform_channel_id,
                                name: channel.name,
                                position: channel.position || 0,
                                channels: []
                            };
                        }
                    });
                    
                    // 找出所有论坛频道
                    const forumChannels = {};
                    this.channels.forEach(channel => {
                        if (channel.type === 15 && channel.is_active !== false) { // 论坛频道类型且未被禁用
                            forumChannels[channel.platform_channel_id] = {
                                id: channel.platform_channel_id,
                                name: channel.name,
                                position: channel.position || 0,
                                threads: []
                            };
                        }
                    });
                    
                    // 将频道分配到对应的分类中
                    this.channels.forEach(channel => {
                        // 跳过分类本身或已禁用的频道
                        if (channel.type === 4 || channel.is_active === false) {
                            return;
                        }
                        
                        // 如果是论坛帖子，添加到对应的论坛频道中
                        if (channel.type === 11 && channel.parent_id && forumChannels[channel.parent_id] && channel.is_active !== false) {
                            forumChannels[channel.parent_id].threads.push(channel);
                            return;
                        }
                        
                        // 如果是论坛频道，添加到对应的分类中
                        if (channel.type === 15 && channel.is_active !== false) {
                            if (channel.parent_id && groups[channel.parent_id]) {
                                groups[channel.parent_id].channels.push(forumChannels[channel.platform_channel_id]);
                            } else {
                                uncategorized.push(forumChannels[channel.platform_channel_id]);
                            }
                            return;
                        }
                        
                        // 处理普通频道
                        if (channel.parent_id && groups[channel.parent_id]) {
                            groups[channel.parent_id].channels.push(channel);
                        } else {
                            uncategorized.push(channel);
                        }
                    });
                    
                    // 对每个分类中的频道按位置排序
                    Object.values(groups).forEach(group => {
                        group.channels.sort((a, b) => (a.position || 0) - (b.position || 0));
                    });
                    
                    // 对每个论坛频道中的帖子按名称排序
                    Object.values(forumChannels).forEach(forum => {
                        forum.threads.sort((a, b) => a.name.localeCompare(b.name));
                    });
                    
                    // 创建结果数组，包括分类和未分类的频道
                    const result = Object.values(groups)
                        .sort((a, b) => (a.position || 0) - (b.position || 0));
                    
                    if (uncategorized.length > 0) {
                        result.push({
                            id: 'uncategorized',
                            name: '未分类',
                            channels: uncategorized
                        });
                    }
                    
                    return result;
                }
            },
            methods: {
                parseJSON(str) {
                    if (!str) return [];
                    if (typeof str === 'object') return str;  // 如果已经是对象，直接返回
                    try {
                        return JSON.parse(str);
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                        return [];
                    }
                },
                async handleScroll(e) {
                    if (!this.selectedChannel || !this.$refs.messageList) return;
                    
                    const element = this.$refs.messageList;
                    const scrollHeight = element.scrollHeight;
                    const scrollTop = Math.ceil(element.scrollTop);
                    const clientHeight = element.clientHeight;
                    
                    // 当滚动到底部时加载更多历史消息
                    if (this.hasMore && !this.loading && scrollTop + clientHeight >= scrollHeight - 50) {
                        await this.loadMessages(this.selectedChannel, true);
                    }
                },
                async loadMessages(channel, loadMore = false) {
                    if (this.loading) return;
                    
                    try {
                        this.loading = true;
                        const page = loadMore ? this.currentPage + 1 : 1;
                        
                        const response = await fetch(`/api/messages?channel_id=${channel.platform_channel_id}&page=${page}&per_page=20`);
                        const data = await response.json();
                        
                        if (response.ok && data.messages) {
                            if (loadMore) {
                                // 将新消息添加到列表后面
                                this.messages = [...this.messages, ...data.messages];
                                this.currentPage = page;
                            } else {
                                this.messages = data.messages;
                                this.currentPage = 1;
                            }
                            
                            this.hasMore = data.messages.length === 20;
                            
                            if (!loadMore) {
                                // 新加载频道时，滚动到顶部
                                this.$nextTick(() => {
                                    if (this.$refs.messageList) {
                                        this.$refs.messageList.scrollTop = 0;
                                    }
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error loading messages:', error);
                        this.$notify.error({
                            title: '错误',
                            message: '加载消息失败'
                        });
                    } finally {
                        this.loading = false;
                    }
                },
                initWebSocket() {
                    this.ws = new WebSocket(`ws://${window.location.host}/ws`);
                    
                    this.ws.onmessage = async (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'system') {
                            this.addMessageLog({
                                channel: 'System',
                                author: 'System',
                                content: data.content
                            });
                        } else if (data.type === 'new_message') {
                            const channelId = data.channel_id;
                            
                            // 添加到消息日志
                            this.addMessageLog({
                                channel: data.channel_name || 'Unknown Channel',
                                author: data.author_name,
                                content: data.content
                            });

                            // 更新未读消息计数
                            if (channelId) {
                                // 如果不是当前选中的频道，增加未读计数
                                if (!this.selectedChannel || this.selectedChannel.platform_channel_id !== channelId) {
                                    // 获取最新的未读计数
                                    await this.fetchUnreadCounts();
                                }
                                
                                // 如果是当前选中的频道，刷新消息列表
                                if (this.selectedChannel && channelId === this.selectedChannel.platform_channel_id) {
                                    await this.loadMessages(this.selectedChannel);
                                }
                            }
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.addMessageLog({
                            channel: 'System',
                            author: 'System',
                            content: 'WebSocket连接已断开，正在重新连接...'
                        });
                        setTimeout(() => this.initWebSocket(), 1000);
                    };
                },
                async loadChannels() {
                    try {
                        const url = '/api/channels' + (this.devMode ? '?include_inactive=true' : '');
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (response.ok) {
                            if (!Array.isArray(data)) {
                                throw new Error('Invalid response format: expected array');
                            }
                            
                            // 确保数据更新触发视图更新
                            this.channels = [];  // 先清空
                            await this.$nextTick();  // 等待 DOM 更新
                            this.$set(this, 'channels', data);  // 设置新数据
                            
                            // 只统计非分类类型的频道
                            const nonCategoryChannels = data.filter(c => c.type !== 4);
                            const forwardingCount = nonCategoryChannels.filter(c => c.is_forwarding).length;
                            const nonForwardingCount = nonCategoryChannels.length - forwardingCount;
                            
                            // 初始化每个频道的最后消息时间
                            data.forEach(channel => {
                                if (!this.lastMessageTimes[channel.platform_channel_id]) {
                                    this.$set(this.lastMessageTimes, channel.platform_channel_id, new Date().toISOString());
                                }
                            });

                            // 初始化所有分类为展开状态
                            data.forEach(channel => {
                                if (channel.type === 4) {
                                    this.$set(this.expandedCategories, channel.platform_channel_id, true);
                                }
                            });
                        } else {
                            throw new Error(`Server returned ${response.status}: ${data.detail || 'Unknown error'}`);
                        }
                    } catch (error) {
                        this.$notify.error({
                            title: '错误',
                            message: '加载频道失败: ' + error.message
                        });
                    }
                },
                async selectChannel(channel) {
                    this.selectedChannel = channel;
                    this.messages = [];
                    this.currentPage = 1;
                    this.hasMore = true;
                    
                    await this.loadMessages(channel);
                    // 先标记为已读，再获取最新的未读计数
                    await this.markChannelRead(channel);
                    await this.fetchUnreadCounts();
                },
                async addMessage() {
                    if (!this.newMessage.content) {
                        alert('Please enter a message');
                        return;
                    }
                    if (!this.newMessage.author_name) {
                        alert('Please enter author name');
                        return;
                    }

                    try {
                        const messageResponse = await fetch('/api/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                content: this.newMessage.content,
                                author_name: this.newMessage.author_name,
                                channel_id: this.selectedChannel.platform_channel_id
                            })
                        });

                        if (!messageResponse.ok) {
                            const errorData = await messageResponse.json();
                            throw new Error(errorData.detail || 'Failed to send message');
                        }

                        await this.loadMessages(this.selectedChannel);
                        this.showAddMessageForm = false;
                        this.newMessage.content = '';
                        this.newMessage.author_name = '';
                        
                        this.addMessageLog({
                            channel: this.selectedChannel.name,
                            author: 'System',
                            content: '消息发送成功'
                        });
                    } catch (error) {
                        console.error('Error sending message:', error);
                        const errorMessage = error.message || '未知错误';
                        this.addMessageLog({
                            channel: this.selectedChannel.name,
                            author: 'System',
                            content: '发送消息出错: ' + errorMessage
                        });
                        alert('发送消息失败: ' + errorMessage);
                    }
                },
                toggleAddMessageForm() {
                    if (this.showAddMessageForm) {
                        // 如果表单是展开的，则收起并清空内容
                        this.showAddMessageForm = false;
                        this.newMessage.content = '';
                        this.newMessage.author_name = '';
                    } else {
                        // 如果表单是收起的，则展开
                        this.showAddMessageForm = true;
                    }
                },
                addSystemLog(log) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.systemLogs.push(`[${timestamp}] ${log}`);
                    this.$nextTick(() => {
                        if (this.$refs.systemLogContainer) {
                            this.$refs.systemLogContainer.scrollTop = this.$refs.systemLogContainer.scrollHeight;
                        }
                    });
                },
                addMessageLog(message) {
                    this.messageLogs.unshift(message);
                    // Keep only the last 100 messages
                    if (this.messageLogs.length > 100) {
                        this.messageLogs.pop();
                    }
                },
                updateUnreadCount(channelId, count) {
                    this.$set(this.unreadCounts, channelId, count);
                },
                clearSystemLogs() {
                    this.systemLogs = [];
                },
                clearMessageLogs() {
                    this.messageLogs = [];
                },
                async syncHistoryMessages() {
                    if (!this.historyMessageCount) {
                        this.$message.warning('请输入要同步的消息数量');
                        return;
                    }
                    if (!confirm(`确定要同步每个频道和帖子的最近 ${this.historyMessageCount} 条消息吗？`)) {
                        return;
                    }
                    this.isSyncing = true;
                    try {
                        const response = await fetch('/api/messages/sync-history', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message_count: parseInt(this.historyMessageCount)
                            })
                        });
                        if (!response.ok) {
                            throw new Error('同步失败');
                        }
                        const result = await response.json();
                        this.$message.success(`同步成功: ${result.message_count} 条消息`);
                        if (this.selectedChannel) {
                            await this.loadMessages();
                        }
                    } catch (error) {
                        this.$message.error('同步失败: ' + error.message);
                    } finally {
                        this.isSyncing = false;
                    }
                },
                async clearDatabase() {
                    if (!confirm('确定要删除所有消息吗？此操作无法撤销！')) {
                        return;
                    }

                    // 显示加载中对话框
                    const loadingInstance = this.$loading({
                        lock: true,
                        text: '正在清除消息...',
                        spinner: 'el-icon-loading',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });
                    try {
                        const response = await fetch('/api/messages/clear-all', {
                            method: 'POST'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            
                            // 清空当前显示的消息
                            this.messages = [];
                            this.currentPage = 1;
                            this.hasMore = false;
                            
                            // 重置未读消息计数
                            this.unreadCounts = {};
                            
                            // 重置所有频道的最后消息时间
                            this.lastMessageTimes = {};
                            
                            this.$notify({
                                title: '成功',
                                message: `已清除 ${result.deleted_messages} 条消息和 ${result.deleted_attachments} 个附件`,
                                type: 'success',
                                duration: 3000
                            });
                            
                            // 如果当前有选中的频道，重新加载该频道
                            if (this.selectedChannel) {
                                await this.loadMessages(this.selectedChannel);
                            }
                        } else {
                            throw new Error('清除数据库失败');
                        }
                    } catch (error) {
                        this.$notify.error({
                            title: '错误',
                            message: '清除消息失败: ' + error.message,
                            duration: 3000
                        });
                    } finally {
                        // 关闭加载中对话框
                        loadingInstance.close();
                    }
                },
                toggleDevMode() {
                    this.devMode = !this.devMode;
                    if (this.devMode) {
                        this.startClocks();
                    } else {
                        this.stopClocks();
                    }
                },
                async syncChannels() {
                    if (!confirm('确定要同步频道和帖子吗？')) {
                        return;
                    }
                    this.isSyncing = true;
                    try {
                        const response = await fetch('/api/channels/sync', {
                            method: 'POST'
                        });
                        if (!response.ok) {
                            throw new Error('同步失败');
                        }
                        const result = await response.json();
                        this.$message.success(`同步成功: ${result.accessible_count} 个频道, ${result.thread_count} 个帖子`);
                        await this.loadChannels();
                    } catch (error) {
                        this.$message.error('同步失败: ' + error.message);
                    } finally {
                        this.isSyncing = false;
                    }
                },
                async refreshMessages() {
                    if (!this.selectedChannel || this.loading) return;
                    
                    // 重置状态
                    this.messages = [];
                    this.currentPage = 1;
                    this.hasMore = true;
                    
                    // 重新加载消息
                    await this.loadMessages(this.selectedChannel);
                    
                    if (this.devMode) {
                        this.addMessageLog({
                            channel: this.selectedChannel.name,
                            author: 'System',
                            content: '手动刷新消息完成'
                        });
                    }
                },
                formatMessageTime(timestamp) {
                    try {
                        const date = new Date(timestamp);
                        if (this.selectedTimezone === 'UTC') {
                            return date.toISOString();
                        } else if (this.selectedTimezone === 'local') {
                            return date.toLocaleString();
                        } else {
                            return date.toLocaleString('en-US', { timeZone: this.selectedTimezone });
                        }
                    } catch (e) {
                        console.error('Error formatting time:', e);
                        return timestamp;
                    }
                },
                updateClocks() {
                    const now = new Date();
                    
                    // 格式化UTC时间
                    const utcOptions = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: 'UTC'
                    };
                    this.utcTime = now.toLocaleString('en-US', utcOptions).replace(',', '');
                    
                    // 格式化选定时区的时间
                    const localOptions = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false,
                        timeZone: this.selectedTimezone === 'local' ? undefined : this.selectedTimezone
                    };
                    this.localTime = now.toLocaleString('en-US', localOptions).replace(',', '');
                },
                startClocks() {
                    this.updateClocks();
                    if (this.clockInterval) {
                        clearInterval(this.clockInterval);
                    }
                    this.clockInterval = setInterval(() => {
                        requestAnimationFrame(() => {
                            this.updateClocks();
                        });
                    }, 1000);
                },
                stopClocks() {
                    if (this.clockInterval) {
                        clearInterval(this.clockInterval);
                        this.clockInterval = null;
                    }
                },
                // 更新时区设置
                updateTimezone(timezone) {
                    this.selectedTimezone = timezone;
                    localStorage.setItem('selectedTimezone', timezone);
                    this.updateClocks();
                },
                async fetchUnreadCounts() {
                    try {
                        const response = await fetch('/api/messages/unread-counts');
                        if (response.ok) {
                            this.unreadCounts = await response.json();
                        }
                    } catch (error) {
                        console.error('Error fetching unread counts:', error);
                    }
                },
                async markChannelRead(channel) {
                    if (!channel) return;
                    try {
                        const response = await fetch(`/api/messages/mark-channel-read`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ channel_id: channel.platform_channel_id })
                        });
                        if (response.ok) {
                            // 清除该频道的未读消息计数
                            this.$delete(this.unreadCounts, channel.platform_channel_id);
                        }
                    } catch (error) {
                        console.error('Error marking channel as read:', error);
                    }
                },
                async markAllChannelsRead() {
                    try {
                        const response = await fetch('/api/messages/mark-all-read', {
                            method: 'POST'
                        });
                        if (response.ok) {
                            // 清除所有未读计数
                            this.unreadCounts = {};
                            this.$notify({
                                title: '成功',
                                message: '已清除所有未读消息',
                                type: 'success',
                                duration: 2000
                            });
                        } else {
                            throw new Error('Failed to mark all as read');
                        }
                    } catch (error) {
                        console.error('Error marking all as read:', error);
                        this.$notify.error({
                            title: '错误',
                            message: '清除未读消息失败',
                            duration: 2000
                        });
                    }
                },
                toggleCategory(categoryId) {
                    this.$set(this.expandedCategories, categoryId, !this.expandedCategories[categoryId]);
                },
                openImageInNewTab(url) {
                    window.open(url, '_blank');
                },
                async setupWebSocket() {
                    try {
                        this.ws = new WebSocket(`ws://${window.location.host}/ws`);
                        
                        this.ws.onopen = () => {
                            this.isConnected = true;
                            this.$notify({
                                title: '连接成功',
                                message: '已成功连接到服务器',
                                type: 'success',
                                duration: 2000
                            });
                        };
                        
                        this.ws.onclose = () => {
                            this.isConnected = false;
                            setTimeout(this.setupWebSocket, 5000);
                        };
                        
                        this.ws.onerror = (error) => {
                            this.isConnected = false;
                        };
                        
                        this.ws.onmessage = this.handleWebSocketMessage;
                    } catch (error) {
                        this.isConnected = false;
                        setTimeout(this.setupWebSocket, 5000);
                    }
                },
                startPingCheck() {
                    this.pingInterval = setInterval(async () => {
                        try {
                            const response = await fetch('/api/ping');
                            const wasConnected = this.isConnected;
                            this.isConnected = response.ok;
                            
                            if (!wasConnected && this.isConnected) {
                                this.$notify({
                                    title: '连接恢复',
                                    message: '服务器连接已恢复',
                                    type: 'success',
                                    duration: 2000
                                });
                            }
                        } catch (error) {
                            this.isConnected = false;
                        }
                    }, 5000);
                },
                startMessageCheck() {
                    this.messageCheckInterval = setInterval(async () => {
                        await this.fetchUnreadCounts();
                        if (this.selectedChannel) {
                            await this.loadMessages(this.selectedChannel);
                        }
                    }, 10000);  // 每10秒刷新一次
                },
                async handleWebSocketMessage(event) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_message') {
                        if (this.selectedChannel && this.selectedChannel.platform_channel_id === data.channel_id) {
                            // 如果当前正在查看该频道，则添加消息到顶部
                            this.messages.unshift({
                                id: data.id,
                                content: data.content,
                                author_name: data.author_name,
                                created_at: data.created_at
                            });
                        }
                        // 无论是否是当前频道，都重新获取未读计数
                        await this.fetchUnreadCounts();
                    }
                },
                async resetChannels() {
                    this.addSystemLog('开始重置频道');
                    try {
                        const response = await fetch('/api/channels/reset', { method: 'POST' });
                        if (!response.ok) {
                            throw new Error('重置频道失败');
                        }
                        this.addSystemLog('重置频道成功，请点击同步按钮更新频道列表');
                        alert('重置成功，请点击同步按钮更新频道列表');
                    } catch (error) {
                        this.addSystemLog('重置频道失败: ' + error.message);
                        console.error('重置频道失败:', error);
                        alert('重置频道失败');
                    }
                },
                scrollToBottom() {
                    if (this.$refs.messageList) {
                        const element = this.$refs.messageList;
                        element.scrollTop = element.scrollHeight;
                    }
                },
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString();
                },
                showImagePreview(attachment) {
                    this.previewImageUrl = `/api/messages/attachments/${attachment.id}`;
                    this.imagePreviewVisible = true;
                },
                async deleteMessage(messageId) {
                    if (!confirm('确定要删除这条消息吗？')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/messages/${messageId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || '删除消息失败');
                        }
                        
                        // 从当前消息列表中移除该消息
                        this.messages = this.messages.filter(msg => msg.id !== messageId);
                        
                        this.$notify({
                            title: '成功',
                            message: '消息已删除',
                            type: 'success',
                            duration: 2000
                        });
                    } catch (error) {
                        this.$notify.error({
                            title: '错误',
                            message: '删除消息失败: ' + error.message,
                            duration: 2000
                        });
                    }
                },
                async toggleForwarding(channel) {
                    const newValue = !channel.is_forwarding;
                    channel.is_forwarding = newValue;  // 立即更新UI
                    try {
                        const response = await fetch(`/api/channels/${channel.platform_channel_id}/forwarding`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                is_forwarding: newValue
                            })
                        });
                        if (!response.ok) {
                            throw new Error('更新失败');
                        }
                        this.$notify({
                            title: '成功',
                            message: `已${newValue ? '开启' : '关闭'}转发`,
                            type: 'success',
                            duration: 2000
                        });
                    } catch (error) {
                        channel.is_forwarding = !newValue;  // 恢复原来的状态
                        this.$notify.error({
                            title: '错误',
                            message: '更新转发状态失败',
                            duration: 2000
                        });
                    }
                },
                toggleForum(forumId) {
                    this.$set(this.expandedForums, forumId, !this.expandedForums[forumId]);
                },
                async syncThreads() {
                    if (!confirm('确定要同步所有论坛帖子吗？')) {
                        return;
                    }
                    this.isSyncing = true;
                    try {
                        const response = await fetch('/api/channels/sync-threads', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message_count: parseInt(this.historyMessageCount) || 100
                            })
                        });
                        if (!response.ok) {
                            throw new Error('同步失败');
                        }
                        const result = await response.json();
                        this.$message.success(`同步成功: ${result.thread_count} 个帖子`);
                        await this.loadChannels();
                    } catch (error) {
                        this.$message.error('同步失败: ' + error.message);
                    } finally {
                        this.isSyncing = false;
                    }
                },
            },
            watch: {
                selectedTimezone() {
                    // 当时区改变时，更新时钟显示
                    this.updateClocks();
                }
            },
            created() {
                // 启动时从localStorage读取时区设置
                const savedTimezone = localStorage.getItem('selectedTimezone');
                if (savedTimezone) {
                    this.selectedTimezone = savedTimezone;
                }
                this.startClocks();
                this.setupWebSocket();
                this.startPingCheck();
                this.loadChannels();
                
                // 每5秒检查一次未读消息
                setInterval(async () => {
                    await this.fetchUnreadCounts();
                }, 5000);
                
                // 如果有选中的频道，每10秒刷新一次消息
                setInterval(async () => {
                    if (this.selectedChannel) {
                        await this.loadMessages(this.selectedChannel);
                    }
                }, 10000);
            },
            beforeDestroy() {
                this.stopClocks();
                if (this.messageCheckInterval) {
                    clearInterval(this.messageCheckInterval);
                }
                if (this.ws) {
                    this.ws.close();
                }
            }
        });
    </script>
</body>
</html> 