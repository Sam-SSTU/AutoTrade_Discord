# AutoTrade_Discord 技术文档

## 系统概述

AutoTrade_Discord 是一个设计用于监控 Discord 频道中的交易信号，使用人工智能进行分析，并可能在币安（Binance）上执行交易的平台。系统从 Discord 频道捕获消息，将其存储在数据库中，并提供一个 Web 界面来查看和管理这些消息。系统还包含用于分析消息中的交易信号以及与币安 API 交互进行交易的组件。

**注意：** 目前币安集成组件和 AI 分析组件尚未正常运行。

## 系统架构

### 核心组件

1. **FastAPI 后端**：主要入口点（`app/main.py`），提供 API 端点和网页服务。
2. **消息监控服务**：监听 Discord 消息的服务。
3. **Discord 客户端**：与 Discord 交互以检索消息和频道信息。
4. **数据库**：PostgreSQL 数据库，用于存储频道、消息、KOL（重要意见领袖）和交易信号。
5. **Web 界面**：由 FastAPI 应用程序提供服务的 HTML 模板。
6. **AI 消息处理器**：用于使用 AI 分析消息（目前不可用）。
7. **币安客户端**：用于在币安上执行交易（目前不可用）。

## 文件结构

```
/
├── alembic/ - 数据库迁移脚本
├── app/ - 主应用程序代码
│   ├── ai/ - AI 组件（目前不可用）
│   │   ├── message_handler.py - 处理 AI 消息处理
│   │   └── models.py - AI 相关模型
│   ├── api/ - API 端点
│   │   ├── channels.py - 频道管理 API
│   │   └── messages.py - 消息管理 API
│   ├── binance/ - 币安集成（目前不可用）
│   │   ├── api/ - 币安 API 端点
│   │   ├── client/ - 币安客户端实现
│   │   ├── models/ - 币安相关模型
│   │   ├── repositories/ - 币安数据访问层
│   │   ├── schemas/ - 币安的 Pydantic 模型
│   │   └── utils/ - 币安的实用函数
│   ├── config/ - 应用程序配置
│   ├── models/ - 数据库模型
│   │   ├── base.py - 基本模型定义
│   │   └── __init__.py - 模型导入
│   ├── services/ - 业务逻辑服务
│   │   ├── discord_client.py - Discord 交互逻辑
│   │   ├── file_utils.py - 文件处理实用工具
│   │   ├── message_handler.py - 消息处理逻辑
│   │   └── message_utils.py - 消息相关实用工具
│   ├── static/ - Web 界面的静态资源
│   ├── templates/ - HTML 模板
│   ├── utils/ - 实用函数
│   ├── main.py - 应用程序入口点
│   ├── database.py - 数据库连接设置
│   ├── models.py - 旧版模型定义
│   ├── redis_config.py - Redis 配置
│   └── routes.py - 网页路由
├── data/ - 数据存储目录
├── docs/ - 文档
├── examples/ - 示例代码和配置
├── storage/ - 文件存储目录
├── venv/ - Python 虚拟环境
├── .env - 环境变量
├── .env.example - 示例环境变量
├── requirements.txt - Python 依赖项
└── reset_db.py - 重置数据库的脚本
```

## 数据模型

### 主要数据库模型

1. **Channel（频道）**：表示 Discord 频道或帖子：
   - 属性：id, platform_channel_id, name, guild_id, guild_name, is_active, is_forwarding 等。

2. **KOL（关键意见领袖）**：表示发布交易信号的 Discord 用户：
   - 属性：id, platform_user_id, name, platform, is_active 等。

3. **Message（消息）**：表示 Discord 频道中的消息：
   - 属性：id, platform_message_id, channel_id, kol_id, content, embeds, referenced_message_id 等。
   - 关系：channel, kol, attachments

4. **Attachment（附件）**：表示附加到消息的文件：
   - 属性：id, message_id, filename, content_type, file_data 等。

5. **UnreadMessage（未读消息）**：跟踪每个频道的未读消息：
   - 属性：id, channel_id, last_read_message_id, unread_count 等。

### 交易模型

1. **TradeSignal（交易信号）**：表示从消息中提取的交易信号：
   - 属性：id, message_id, signal_type, symbol, entry_price, take_profit, stop_loss, leverage, direction, status 等。
   - 关系：message, orders

2. **Order（订单）**：表示在币安上执行的订单：
   - 属性：id, trade_signal_id, order_type, symbol, quantity, price, status, execution_details 等。
   - 关系：trade_signal

3. **RiskRule（风险规则）**：表示用于管理交易风险的规则：
   - 属性：id, name, description, rule_type, parameters, is_active 等。

## 应用流程

1. **启动过程**：
   - FastAPI 应用程序在 `app/main.py` 中启动。
   - 若不存在，则创建数据库表。
   - 初始化 `MessageHandler` 以监控新消息。

2. **Discord 消息监控**：
   - `MessageHandler`（`app/services/message_handler.py`）启动监控任务。
   - `DiscordClient`（`app/services/discord_client.py`）连接到 Discord 并监听消息。
   - 收到消息后，会进行处理并存储在数据库中。

3. **API 端点**：
   - 频道管理（`app/api/channels.py`）：
     - 列出、同步、激活/停用频道
     - 同步论坛帖子
     - 更新频道分类
   - 消息管理（`app/api/messages.py`）：
     - 列出、搜索、标记消息为已读
     - 管理附件
     - 处理消息进行 AI 分析（目前不可用）

4. **Web 界面**：
   - 主页（`/`）：显示 Discord 频道和消息
   - AI 页面（`/ai`）：AI 分析界面（目前不可用）
   - WebSocket 端点用于实时更新

5. **AI 处理**（目前不可用）：
   - `AIMessageHandler`（`app/ai/message_handler.py`）将处理消息并提取交易信号。
   - WebSocket 连接将更新推送给客户端。

6. **币安集成**（目前不可用）：
   - 将根据信号处理交易执行。
   - 将提供交易历史和账户信息。

## 配置

应用程序使用环境变量（`.env` 文件）进行配置：
- 数据库连接详情（PostgreSQL）
- Discord API 凭据
- 币安 API 凭据
- 其他应用程序设置

## 执行流程示例

1. 在 Discord 频道中发布消息。
2. `DiscordClient` 通过 Discord API 接收消息。
3. `MessageHandler` 处理消息并将其存储在数据库中。
4. 消息广播给连接的 WebSocket 客户端。
5. 消息将由 AI 组件分析（如果功能正常）。
6. 将提取交易信号（如果 AI 功能正常）。
7. 订单将在币安上下单（如果币安集成功能正常）。
8. 结果将显示在 Web 界面中。

## 当前限制

1. **币安集成**：币安集成目前不可用。代码库包含了币安 API 交互的结构，但目前不可运行。

2. **AI 组件**：用于分析消息和提取交易信号的 AI 组件不可用。基础架构存在但不可运行。

## 开发下一步

1. 修复并实现 AI 组件，用于分析消息中的交易信号。
2. 实现并测试币安集成，用于执行交易。
3. 增强应用程序中的错误处理和日志记录。
4. 为关键组件实现单元和集成测试。
5. 改进 Web 界面以提供更好的用户体验。

## 关键文件功能说明

### app/main.py
作为应用程序的入口点，该文件负责：
- 初始化 FastAPI 应用
- 配置中间件（CORS等）
- 注册路由（API和页面路由）
- 设置静态文件服务
- 提供健康检查端点
- 管理 WebSocket 连接

### app/services/message_handler.py
处理从 Discord 接收的消息，功能包括：
- 启动和停止消息监控服务
- 处理 Discord 消息，将其存储到数据库
- 管理未读消息计数
- 处理论坛帖子和线程消息

### app/services/discord_client.py
与 Discord API 交互的客户端，功能包括：
- 获取频道和服务器信息
- 同步频道列表到数据库
- 获取频道消息历史
- 处理和存储消息
- 管理 WebSocket 连接，用于前端实时更新

### app/models/base.py
定义系统核心数据模型，包括：
- Channel（频道）模型
- KOL（关键意见领袖）模型
- Message（消息）模型
- Attachment（附件）模型
- UnreadMessage（未读消息）模型

### app/ai/message_handler.py
设计用于处理消息的 AI 组件，目前不可用。计划功能包括：
- 连接和断开 WebSocket 客户端
- 存储消息到 AI 消息表
- 广播消息到所有连接的客户端

### app/api/channels.py
频道管理 API，提供以下端点：
- 获取频道列表
- 同步 Discord 频道
- 同步论坛帖子
- 激活和停用频道
- 更新频道分类
- 重置频道 